<!DOCTYPE html>
<html>
<head>
  <!-- Include the intlTelInput library CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/18.2.1/css/intlTelInput.min.css">
</head>
<body>

<form>
  <label for="phone">Phone:</label>
  <input type="tel" id="phone" placeholder="">

  <!-- Add an element to display validation error message -->
  <div id="phone-error" style="color: red;"></div>
</form>

<!-- Include the intlTelInput library script -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/18.2.1/js/intlTelInput.min.js"></script>
<script>
  // Initialize intl-tel-input on the phone input field
  const input = document.querySelector("#phone");
  const iti = window.intlTelInput(input, {
    utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/18.2.1/js/utils.js",
  });

  // Preferred countries and their corresponding max lengths
  const preferredCountriesMaxLength = {
    "+971": 9,
    "+974": 8,
    "+968": 8,
    "+33": 10,
    "+49": 11,
    "+39": 10,
    "+47": 12,
    "+41": null, // No specific max length
    "+44": 10,
  };

  // Keep track of whether the country dropdown is being clicked
  let isCountryDropdownClicked = false;

  // Helper function to validate and show error for phone field
  function validatePhone() {
    const isValid = iti.isValidNumber();
    const selectedCountry = iti.getSelectedCountryData();

    if (!isValid || isCountryDropdownClicked) {
      document.getElementById('phone-error').textContent = 'Invalid phone number';
      input.classList.add('error');
    } else {
      const phoneValue = input.value;
      const countryCode = selectedCountry.dialCode;
      const maxDigits = preferredCountriesMaxLength[countryCode];
      
      if (maxDigits && phoneValue.replace(countryCode, '').length > maxDigits) {
        document.getElementById('phone-error').textContent = `Phone number is too long for ${selectedCountry.name}`;
        input.classList.add('error');
      } else {
        document.getElementById('phone-error').textContent = '';
        input.classList.remove('error');
      }
    }
  }

  // Trigger validation when the user leaves focus from the phone input field
  input.addEventListener('blur', validatePhone);

  // Validate phone field when the form is submitted
  document.querySelector("form").addEventListener("submit", function (event) {
    event.preventDefault();
    validatePhone();
  });

  // Detect clicks on the country dropdown
  document.querySelector(".iti__selected-flag").addEventListener("click", function () {
    isCountryDropdownClicked = true;
    setTimeout(function () {
      isCountryDropdownClicked = false;
      validatePhone();
    }, 100);
  });
</script>

</body>
</html>
